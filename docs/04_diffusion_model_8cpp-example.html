<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
  <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=11" />
  <meta name="generator" content="Doxygen 1.9.7" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OpenPFC: an open source framework for high performance 3D phase field crystal simulations</title>
  <link href="tabs.css" rel="stylesheet" type="text/css" />
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
  <script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
  <script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
  <script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
  <script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
  </script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <link href="custom.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
  <style>
    .github-corner svg {
      fill: var(--primary-light-color);
      color: var(--page-background-color);
      width: 72px;
      height: 72px;
    }
    .github-corner:hover .octo-arm {
      animation: octocat-wave 560ms ease-in-out
    }
    @keyframes octocat-wave {
      0%,
      100% {
        transform: rotate(0)
      }
      20%,
      60% {
        transform: rotate(-25deg)
      }
      40%,
      80% {
        transform: rotate(10deg)
      }
    }
    @media (max-width:500px) {
      .github-corner:hover .octo-arm {
        animation: none
      }
      .github-corner .octo-arm {
        animation: octocat-wave 560ms ease-in-out
      }
    }
    @media screen and (max-width: 767px) {
      .github-corner svg {
        width: 50px;
        height: 50px;
      }
      #projectnumber {
        margin-right: 22px;
      }
    }
  </style>
</head>
<body>
  <!-- https://tholman.com/github-corners/ -->
  <a href="https://github.com/VTT-ProperTune/OpenPFC" class="github-corner" title="View source on GitHub"
    target="_blank">
    <svg viewBox="0 0 250 250" width="40" height="40"
      style="position: absolute; top: 0; border: 0; right: 0; z-index: 99;" aria-hidden="true">
      <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
      <path
        d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
        fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
      <path
        d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
        fill="currentColor" class="octo-body"></path>
    </svg></a>
    <div id="top">
      <!-- do not remove this div, it is closed by doxygen! -->
      <div id="titlearea">
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr id="projectrow">
              <td id="projectlogo"><img alt="Logo" src="logo.png" /></td>
              <td id="projectalign">
                <div id="projectname">OpenPFC
                  <span id="projectnumber">&#160;0.1.0</span>
                </div>
                <div id="projectbrief">Phase Field Crystal simulation framework</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <!-- end header part -->
<!-- Generated by Doxygen 1.9.7 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('04_diffusion_model_8cpp-example.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">04_diffusion_model.cpp</div></div>
</div><!--header-->
<div class="contents">
<p>Let's embark on the journey of physics modeling. Together, we will construct a captivating diffusion model and unleash its mysteries using OpenPFC. This example implements a simple diffusion model using the OpenPFC library. The code demonstrates a low-level implementation of the model, where the simulation is manually stepped and the initial conditions are defined inside the model. It also shows how to perform local and global reductions using MPI to calculate global properties of the field variable.</p>
<p>The <a class="el" href="classDiffusion.html">Diffusion</a> class is derived from the base class Model provided by the OpenPFC library. It overrides two class methods:</p>
<ol type="1">
<li><code>initialize(double dt)</code>: This method is called once to initialize the necessary parameters and data structures for the simulation. It allocates memory for the main variable, psi, and its Fourier transform, psi_F. It also constructs the linear operator L, which is used to solve the diffusion equation.</li>
<li><code>step(double dt)</code>: This method is called to step the model forward in time by one time increment, dt. It applies the linear operator L to the Fourier transform of psi, psi_F, and then performs an inverse Fourier transform to obtain the updated psi values. It also calculates the minimum and maximum values of psi locally for each MPI rank and performs reduction operations to obtain the global minimum and maximum values.</li>
</ol>
<p>The <code><a class="el" href="04__diffusion__model_8cpp.html#a13a43e6d814de94978c515cb084873b1">run()</a></code> function defines the world dimensions and discretization parameters, constructs the World, Decomposition, FFT, and <a class="el" href="classDiffusion.html">Diffusion</a> objects, and initializes the simulation. It then enters a loop where the model is stepped forward in time until a specified stopping time is reached. During each iteration, the current time, the iteration number, and the minimum and maximum values of psi are printed.</p>
<p>Expected output is: </p><pre class="fragment"> ( initialization messages ... )
 n = 0, t = 0.000000000000, psi[133152] = 1.000000000000
 n = 1, t = 0.013985739333, psi[133152] = 0.979721090279
 n = 2, t = 0.027971478665, psi[133152] = 0.960110027682
 n = 3, t = 0.041957217998, psi[133152] = 0.941136780128
 n = 4, t = 0.055942957330, psi[133152] = 0.922773010503
 ( time stepping continues ...)
 n = 40, t = 0.559429573303, psi[133152] = 0.516585236400
 n = 41, t = 0.573415312636, psi[133152] = 0.509734461852
 n = 42, t = 0.587401051968, psi[133152] = 0.503032957135
</pre><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;algorithm&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;limits&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="decomposition_8hpp.html">openpfc/decomposition.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fft_8hpp.html">openpfc/fft.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="model_8hpp.html">openpfc/model.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="world_8hpp.html">openpfc/world.hpp</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span>std;</div>
<div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespacepfc.html">pfc</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span><a id="_a0" name="_a0"></a><a class="code hl_class" href="classDiffusion.html">Diffusion</a> : <span class="keyword">public</span> <a id="_a1" name="_a1"></a><a class="code hl_class" href="classpfc_1_1Model.html">Model</a> {</div>
<div class="line">  <span class="keyword">using </span>Model::Model; <span class="comment">// &quot;Inherit&quot; the default constructor of base class</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  vector&lt;double&gt; opL, psi;       <span class="comment">// Define linear operator opL and unknown (real) psi</span></div>
<div class="line">  vector&lt;complex&lt;double&gt;&gt; psi_F; <span class="comment">// Define (complex) psi</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  <span class="keywordtype">double</span> <a id="a2" name="a2"></a><a class="code hl_variable" href="classDiffusion.html#a6ad3de2af17be6a8bd02984e44eeae52">psi_min</a>, <a id="a3" name="a3"></a><a class="code hl_variable" href="classDiffusion.html#ac1d50c7d6399f40c5ded1f6cb18101c7">psi_max</a>; <span class="comment">// minimum and maximum values of psi for this rank</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> <a id="a4" name="a4"></a><a class="code hl_function" href="classDiffusion.html#a3f3e65a63f5919d13a4aed39c2ed406f">initialize</a>(<span class="keywordtype">double</span> dt)<span class="keyword"> override </span>{</div>
<div class="line">    <span class="keywordflow">if</span> (<a id="a5" name="a5"></a><a class="code hl_variable" href="classpfc_1_1Model.html#ade57ace089ccbd4a2a07af3a74aa49d7">rank0</a>) cout &lt;&lt; <span class="stringliteral">&quot;Allocate space&quot;</span> &lt;&lt; endl;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Get references to world, fft and domain decomposition</span></div>
<div class="line">    <span class="keyword">const</span> <a id="_a6" name="_a6"></a><a class="code hl_class" href="classpfc_1_1World.html">World</a> &amp;w = <a id="a7" name="a7"></a><a class="code hl_function" href="classpfc_1_1Model.html#ac60d580e7e9ce3a268414f92131a95e1">get_world</a>();</div>
<div class="line">    <a id="_a8" name="_a8"></a><a class="code hl_class" href="classpfc_1_1FFT.html">FFT</a> &amp;<a id="a9" name="a9"></a><a class="code hl_function" href="mpi__timers_8cpp.html#a3a49057ffba576f4b5efe09f8a175879">fft</a> = <a id="a10" name="a10"></a><a class="code hl_function" href="classpfc_1_1Model.html#a06a03a46398d52a3a3afb7490d3e1c41">get_fft</a>();</div>
<div class="line">    <span class="keyword">const</span> <a id="_a11" name="_a11"></a><a class="code hl_class" href="classpfc_1_1Decomposition.html">Decomposition</a> &amp;decomp = <a id="a12" name="a12"></a><a class="code hl_function" href="classpfc_1_1Model.html#a114dbe9ce04ba6e719e232dea52d4313">get_decomposition</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Allocate space for the main variable and it&#39;s fourier transform</span></div>
<div class="line">    psi.resize(<a class="code hl_function" href="mpi__timers_8cpp.html#a3a49057ffba576f4b5efe09f8a175879">fft</a>.size_inbox());</div>
<div class="line">    psi_F.resize(<a class="code hl_function" href="mpi__timers_8cpp.html#a3a49057ffba576f4b5efe09f8a175879">fft</a>.size_outbox());</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">    Construct linear operator L</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">    Because we are doing FFT between real and complex using symmetry,</span></div>
<div class="line"><span class="comment">    it&#39;s enough to define only a half of the operator. Thus, the operator size</span></div>
<div class="line"><span class="comment">    matches with the outbox.</span></div>
<div class="line"><span class="comment">    */</span></div>
<div class="line">    opL.resize(<a class="code hl_function" href="mpi__timers_8cpp.html#a3a49057ffba576f4b5efe09f8a175879">fft</a>.size_outbox());</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">    World is defining the global dimensions of the problem as well as origin and</span></div>
<div class="line"><span class="comment">    chosen discretization parameters.</span></div>
<div class="line"><span class="comment">    */</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code hl_variable" href="classpfc_1_1Model.html#ade57ace089ccbd4a2a07af3a74aa49d7">rank0</a>) cout &lt;&lt; <span class="stringliteral">&quot;World: &quot;</span> &lt;&lt; w &lt;&lt; endl;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">    Upper and lower limits for this particular MPI rank, in both inbox and</span></div>
<div class="line"><span class="comment">    outbox, are given by domain decomposition object</span></div>
<div class="line"><span class="comment">    */</span></div>
<div class="line">    <a class="code hl_typedef" href="namespacepfc.html#aef91c910d177dcf33a7896d436dabdae">Vec3&lt;int&gt;</a> i_low = decomp.<a id="a13" name="a13"></a><a class="code hl_variable" href="classpfc_1_1Decomposition.html#a78a2cd4304a8a69665c3b24503ff8c73">inbox</a>.low;</div>
<div class="line">    <a class="code hl_typedef" href="namespacepfc.html#aef91c910d177dcf33a7896d436dabdae">Vec3&lt;int&gt;</a> i_high = decomp.<a class="code hl_variable" href="classpfc_1_1Decomposition.html#a78a2cd4304a8a69665c3b24503ff8c73">inbox</a>.high;</div>
<div class="line">    <a class="code hl_typedef" href="namespacepfc.html#aef91c910d177dcf33a7896d436dabdae">Vec3&lt;int&gt;</a> o_low = decomp.<a id="a14" name="a14"></a><a class="code hl_variable" href="classpfc_1_1Decomposition.html#a04df6a82361a68e5ac36808259997f5d">outbox</a>.low;</div>
<div class="line">    <a class="code hl_typedef" href="namespacepfc.html#aef91c910d177dcf33a7896d436dabdae">Vec3&lt;int&gt;</a> o_high = decomp.<a class="code hl_variable" href="classpfc_1_1Decomposition.html#a04df6a82361a68e5ac36808259997f5d">outbox</a>.high;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">    Typically initial conditions are constructed elsewhere. However, to keep</span></div>
<div class="line"><span class="comment">    things as simple as possible, the initial condition can be also constructed</span></div>
<div class="line"><span class="comment">    here.</span></div>
<div class="line"><span class="comment">    */</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code hl_variable" href="classpfc_1_1Model.html#ade57ace089ccbd4a2a07af3a74aa49d7">rank0</a>) cout &lt;&lt; <span class="stringliteral">&quot;Create initial condition&quot;</span> &lt;&lt; endl;</div>
<div class="line">    <span class="keywordtype">int</span> idx = 0;</div>
<div class="line">    <span class="keywordtype">double</span> D = 1.0;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = i_low[2]; k &lt;= i_high[2]; k++) {</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = i_low[1]; j &lt;= i_high[1]; j++) {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = i_low[0]; i &lt;= i_high[0]; i++) {</div>
<div class="line">          <span class="keywordtype">double</span> x = w.<a id="a15" name="a15"></a><a class="code hl_variable" href="classpfc_1_1World.html#acc6ffdae16ec121877b6b52eb4d20b6e">x0</a> + i * w.<a id="a16" name="a16"></a><a class="code hl_variable" href="classpfc_1_1World.html#a78728443e7c39c89da0a919fcdb584df">dx</a>;</div>
<div class="line">          <span class="keywordtype">double</span> y = w.<a id="a17" name="a17"></a><a class="code hl_variable" href="classpfc_1_1World.html#af70d91e76a70f703b84394a8f58df90d">y0</a> + j * w.<a id="a18" name="a18"></a><a class="code hl_variable" href="classpfc_1_1World.html#a07404e069e3188e737c45964446dec49">dy</a>;</div>
<div class="line">          <span class="keywordtype">double</span> z = w.<a id="a19" name="a19"></a><a class="code hl_variable" href="classpfc_1_1World.html#a4a5f1f99377c9ad310c15bfeba8c7fee">z0</a> + k * w.<a id="a20" name="a20"></a><a class="code hl_variable" href="classpfc_1_1World.html#aefac04e64d4287f792ecb22e7f0f3c2f">dz</a>;</div>
<div class="line">          psi[idx] = exp(-(x * x + y * y + z * z) / (4.0 * D));</div>
<div class="line">          idx += 1;</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">    The main thing along with allocating workspace for simulation is to prepare</span></div>
<div class="line"><span class="comment">    operators, thus making the actual time stepping as fast as possible.</span></div>
<div class="line"><span class="comment">    */</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code hl_variable" href="classpfc_1_1Model.html#ade57ace089ccbd4a2a07af3a74aa49d7">rank0</a>) cout &lt;&lt; <span class="stringliteral">&quot;Prepare operators&quot;</span> &lt;&lt; endl;</div>
<div class="line">    idx = 0;</div>
<div class="line">    <span class="keywordtype">double</span> pi = std::atan(1.0) * 4.0;</div>
<div class="line">    <span class="keywordtype">double</span> fx = 2.0 * pi / (w.<a class="code hl_variable" href="classpfc_1_1World.html#a78728443e7c39c89da0a919fcdb584df">dx</a> * w.<a id="a21" name="a21"></a><a class="code hl_variable" href="classpfc_1_1World.html#af816f40f453aaf1b91a339fbc982ed8b">Lx</a>);</div>
<div class="line">    <span class="keywordtype">double</span> fy = 2.0 * pi / (w.<a class="code hl_variable" href="classpfc_1_1World.html#a07404e069e3188e737c45964446dec49">dy</a> * w.<a id="a22" name="a22"></a><a class="code hl_variable" href="classpfc_1_1World.html#ab0b0ef4d407bcdb3247e3d98884e0434">Ly</a>);</div>
<div class="line">    <span class="keywordtype">double</span> fz = 2.0 * pi / (w.<a class="code hl_variable" href="classpfc_1_1World.html#aefac04e64d4287f792ecb22e7f0f3c2f">dz</a> * w.<a id="a23" name="a23"></a><a class="code hl_variable" href="classpfc_1_1World.html#af70f18f705556771f40034b03fc3a239">Lz</a>);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = o_low[2]; k &lt;= o_high[2]; k++) {</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = o_low[1]; j &lt;= o_high[1]; j++) {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = o_low[0]; i &lt;= o_high[0]; i++) {</div>
<div class="line">          <span class="comment">// Laplacian operator -k^2</span></div>
<div class="line">          <span class="keywordtype">double</span> ki = (i &lt;= w.<a class="code hl_variable" href="classpfc_1_1World.html#af816f40f453aaf1b91a339fbc982ed8b">Lx</a> / 2) ? i * fx : (i - w.<a class="code hl_variable" href="classpfc_1_1World.html#af816f40f453aaf1b91a339fbc982ed8b">Lx</a>) * fx;</div>
<div class="line">          <span class="keywordtype">double</span> kj = (j &lt;= w.<a class="code hl_variable" href="classpfc_1_1World.html#ab0b0ef4d407bcdb3247e3d98884e0434">Ly</a> / 2) ? j * fy : (j - w.<a class="code hl_variable" href="classpfc_1_1World.html#ab0b0ef4d407bcdb3247e3d98884e0434">Ly</a>) * fy;</div>
<div class="line">          <span class="keywordtype">double</span> kk = (k &lt;= w.<a class="code hl_variable" href="classpfc_1_1World.html#af70f18f705556771f40034b03fc3a239">Lz</a> / 2) ? k * fz : (k - w.<a class="code hl_variable" href="classpfc_1_1World.html#af70f18f705556771f40034b03fc3a239">Lz</a>) * fz;</div>
<div class="line">          <span class="keywordtype">double</span> kLap = -(ki * ki + kj * kj + kk * kk);</div>
<div class="line">          opL[idx++] = 1.0 / (1.0 - dt * kLap);</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> <a id="a24" name="a24"></a><a class="code hl_function" href="classDiffusion.html#ad85cf4e5efd5b48c340b48befc994f82">step</a>(<span class="keywordtype">double</span>)<span class="keyword"> override </span>{</div>
<div class="line">    <a class="code hl_class" href="classpfc_1_1FFT.html">FFT</a> &amp;<a class="code hl_function" href="mpi__timers_8cpp.html#a3a49057ffba576f4b5efe09f8a175879">fft</a> = <a class="code hl_function" href="classpfc_1_1Model.html#a06a03a46398d52a3a3afb7490d3e1c41">get_fft</a>();    <span class="comment">// Get reference to FFT object</span></div>
<div class="line">    <a class="code hl_function" href="mpi__timers_8cpp.html#a3a49057ffba576f4b5efe09f8a175879">fft</a>.forward(psi, psi_F); <span class="comment">// Perform forward FFT, psi_F = fft(psi)</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0, N = psi_F.size(); k &lt; N; k++) {</div>
<div class="line">      psi_F[k] = opL[k] * psi_F[k]; <span class="comment">// Calculate result psi_F = opL*psi_F</span></div>
<div class="line">    }</div>
<div class="line">    <a class="code hl_function" href="mpi__timers_8cpp.html#a3a49057ffba576f4b5efe09f8a175879">fft</a>.backward(psi_F, psi); <span class="comment">// Perform backward FFT, psi = ifft(psi_F)</span></div>
<div class="line">    <a id="a25" name="a25"></a><a class="code hl_function" href="classDiffusion.html#af70b504576a9082c7e73abce7b4398c7">find_minmax</a>();            <span class="comment">// find minimum and maximum values of psi</span></div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> <a class="code hl_function" href="classDiffusion.html#af70b504576a9082c7e73abce7b4398c7">find_minmax</a>() {</div>
<div class="line">    <span class="comment">// Count local minimum and maximum for this particular rank</span></div>
<div class="line">    <span class="keywordtype">double</span> local_min = std::numeric_limits&lt;double&gt;::max();</div>
<div class="line">    <span class="keywordtype">double</span> local_max = std::numeric_limits&lt;double&gt;::min();</div>
<div class="line">    <span class="keyword">auto</span> min_max_finder = [&amp;local_min, &amp;local_max](<span class="keyword">const</span> <span class="keywordtype">double</span> &amp;value) {</div>
<div class="line">      local_min = std::min(local_min, value);</div>
<div class="line">      local_max = std::max(local_max, value);</div>
<div class="line">    };</div>
<div class="line">    std::for_each(psi.begin(), psi.end(), min_max_finder);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// This would print maximum only for this particular part of domain attached</span></div>
<div class="line">    <span class="comment">// to this MPI process, but usually that is NOT what we are trying to do:</span></div>
<div class="line">    <span class="comment">// cout &lt;&lt; &quot;max = &quot; &lt;&lt; local_max &lt;&lt; endl;</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Thus, we need some MPI communication. We use MPI_Reduce to make MIN and</span></div>
<div class="line">    <span class="comment">// MAX reductions and send results to rank 0.</span></div>
<div class="line">    MPI_Reduce(&amp;local_min, &amp;<a class="code hl_variable" href="classDiffusion.html#a6ad3de2af17be6a8bd02984e44eeae52">psi_min</a>, 1, MPI_DOUBLE, MPI_MIN, 0, MPI_COMM_WORLD);</div>
<div class="line">    MPI_Reduce(&amp;local_max, &amp;<a class="code hl_variable" href="classDiffusion.html#ac1d50c7d6399f40c5ded1f6cb18101c7">psi_max</a>, 1, MPI_DOUBLE, MPI_MAX, 0, MPI_COMM_WORLD);</div>
<div class="line">    <span class="comment">//                               ^ size                  ^ rank where to send</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// If the result is needed in all other ranks also, we can use MPI_Allreduce</span></div>
<div class="line">    <span class="comment">// to do that:</span></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">    MPI_Allreduce(&amp;local_min, &amp;psi_min, 1, MPI_DOUBLE, MPI_MIN, comm);</span></div>
<div class="line"><span class="comment">    MPI_Allreduce(&amp;local_max, &amp;psi_max, 1, MPI_DOUBLE, MPI_MAX, comm);</span></div>
<div class="line"><span class="comment">    */</span></div>
<div class="line">  }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a id="a26" name="a26"></a><a class="code hl_function" href="04__diffusion__model_8cpp.html#a13a43e6d814de94978c515cb084873b1">run</a>() {</div>
<div class="line">  <span class="comment">// Define world</span></div>
<div class="line">  <span class="keywordtype">int</span> Lx = 64;</div>
<div class="line">  <span class="keywordtype">int</span> Ly = Lx;</div>
<div class="line">  <span class="keywordtype">int</span> Lz = Lx;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> pi = 3;</div>
<div class="line">  <span class="keywordtype">double</span> dx = 2.0 * pi / 8.0;</div>
<div class="line">  <span class="keywordtype">double</span> dy = dx;</div>
<div class="line">  <span class="keywordtype">double</span> dz = dx;</div>
<div class="line">  <span class="keywordtype">double</span> x0 = -0.5 * Lx * dx;</div>
<div class="line">  <span class="keywordtype">double</span> y0 = -0.5 * Ly * dy;</div>
<div class="line">  <span class="keywordtype">double</span> z0 = -0.5 * Lz * dz;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Construct world, decomposition, fft and model</span></div>
<div class="line">  <a class="code hl_class" href="classpfc_1_1World.html">World</a> world({Lx, Ly, Lz}, {x0, y0, z0}, {dx, dy, dz});</div>
<div class="line">  <a class="code hl_class" href="classpfc_1_1Decomposition.html">Decomposition</a> decomp(world);</div>
<div class="line">  <a class="code hl_class" href="classpfc_1_1FFT.html">FFT</a> <a class="code hl_function" href="mpi__timers_8cpp.html#a3a49057ffba576f4b5efe09f8a175879">fft</a>(decomp);</div>
<div class="line">  <a class="code hl_class" href="classDiffusion.html">Diffusion</a> model(<a class="code hl_function" href="mpi__timers_8cpp.html#a3a49057ffba576f4b5efe09f8a175879">fft</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Define time</span></div>
<div class="line">  <span class="keywordtype">double</span> t = 0.0;</div>
<div class="line">  <span class="keywordtype">double</span> t_stop = 0.5874010519681994;</div>
<div class="line">  <span class="keywordtype">double</span> dt = (t_stop - t) / 42;</div>
<div class="line">  <span class="keywordtype">int</span> n = 0; <span class="comment">// increment counter</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Initialize the model before starting time stepping</span></div>
<div class="line">  model.initialize(dt);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Loop until we are in t_stop</span></div>
<div class="line">  <span class="keywordflow">if</span> (model.rank0) cout &lt;&lt; <span class="stringliteral">&quot;n = 0, t = 0, min = 0.0, max = 1.0&quot;</span> &lt;&lt; endl;</div>
<div class="line">  <span class="keywordflow">while</span> (t &lt;= t_stop) {</div>
<div class="line">    t += dt;</div>
<div class="line">    n += 1;</div>
<div class="line">    model.step(dt);</div>
<div class="line">    <span class="keywordflow">if</span> (model.rank0)</div>
<div class="line">      cout &lt;&lt; <span class="stringliteral">&quot;n = &quot;</span> &lt;&lt; n &lt;&lt; <span class="stringliteral">&quot;, t = &quot;</span> &lt;&lt; t &lt;&lt; <span class="stringliteral">&quot;, min = &quot;</span> &lt;&lt; model.psi_min &lt;&lt; <span class="stringliteral">&quot;, max = &quot;</span> &lt;&lt; model.psi_max &lt;&lt; endl;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Check the result, we should be very close to 0.5</span></div>
<div class="line">  <span class="keywordflow">if</span> (model.rank0) {</div>
<div class="line">    <span class="keywordflow">if</span> (abs(model.psi_max - 0.5) &lt; 0.01) {</div>
<div class="line">      cout &lt;&lt; <span class="stringliteral">&quot;Test pass!&quot;</span> &lt;&lt; endl;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      cerr &lt;&lt; <span class="stringliteral">&quot;Test failed!&quot;</span> &lt;&lt; endl;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a id="a27" name="a27"></a><a class="code hl_function" href="01__hello__world_8cpp.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[]) {</div>
<div class="line">  cout &lt;&lt; std::fixed;</div>
<div class="line">  cout.precision(12);</div>
<div class="line">  MPI_Init(&amp;argc, &amp;argv);</div>
<div class="line">  <a class="code hl_function" href="04__diffusion__model_8cpp.html#a13a43e6d814de94978c515cb084873b1">run</a>();</div>
<div class="line">  MPI_Finalize();</div>
<div class="line">}</div>
<div class="ttc" id="a01__hello__world_8cpp_html_ae66f6b31b5ad750f1fe042a706a4e3d4"><div class="ttname"><a href="01__hello__world_8cpp.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a></div><div class="ttdeci">int main()</div><div class="ttdef"><b>Definition</b> 01_hello_world.cpp:30</div></div>
<div class="ttc" id="a04__diffusion__model_8cpp_html_a13a43e6d814de94978c515cb084873b1"><div class="ttname"><a href="04__diffusion__model_8cpp.html#a13a43e6d814de94978c515cb084873b1">run</a></div><div class="ttdeci">void run()</div><div class="ttdef"><b>Definition</b> 04_diffusion_model.cpp:211</div></div>
<div class="ttc" id="aclassDiffusion_html"><div class="ttname"><a href="classDiffusion.html">Diffusion</a></div><div class="ttdef"><b>Definition</b> 04_diffusion_model.cpp:59</div></div>
<div class="ttc" id="aclassDiffusion_html_a3f3e65a63f5919d13a4aed39c2ed406f"><div class="ttname"><a href="classDiffusion.html#a3f3e65a63f5919d13a4aed39c2ed406f">Diffusion::initialize</a></div><div class="ttdeci">void initialize(double dt) override</div><div class="ttdoc">Initialize the diffusion model.</div><div class="ttdef"><b>Definition</b> 04_diffusion_model.cpp:78</div></div>
<div class="ttc" id="aclassDiffusion_html_a6ad3de2af17be6a8bd02984e44eeae52"><div class="ttname"><a href="classDiffusion.html#a6ad3de2af17be6a8bd02984e44eeae52">Diffusion::psi_min</a></div><div class="ttdeci">double psi_min</div><div class="ttdef"><b>Definition</b> 04_diffusion_model.cpp:67</div></div>
<div class="ttc" id="aclassDiffusion_html_ac1d50c7d6399f40c5ded1f6cb18101c7"><div class="ttname"><a href="classDiffusion.html#ac1d50c7d6399f40c5ded1f6cb18101c7">Diffusion::psi_max</a></div><div class="ttdeci">double psi_max</div><div class="ttdef"><b>Definition</b> 04_diffusion_model.cpp:67</div></div>
<div class="ttc" id="aclassDiffusion_html_ad85cf4e5efd5b48c340b48befc994f82"><div class="ttname"><a href="classDiffusion.html#ad85cf4e5efd5b48c340b48befc994f82">Diffusion::step</a></div><div class="ttdeci">void step(double) override</div><div class="ttdoc">The actual time stepping function.</div><div class="ttdef"><b>Definition</b> 04_diffusion_model.cpp:166</div></div>
<div class="ttc" id="aclassDiffusion_html_af70b504576a9082c7e73abce7b4398c7"><div class="ttname"><a href="classDiffusion.html#af70b504576a9082c7e73abce7b4398c7">Diffusion::find_minmax</a></div><div class="ttdeci">void find_minmax()</div><div class="ttdoc">A simple MPI communication example.</div><div class="ttdef"><b>Definition</b> 04_diffusion_model.cpp:182</div></div>
<div class="ttc" id="aclasspfc_1_1Decomposition_html"><div class="ttname"><a href="classpfc_1_1Decomposition.html">pfc::Decomposition</a></div><div class="ttdoc">Class representing the domain decomposition for parallel Fast Fourier Transform.</div><div class="ttdef"><b>Definition</b> decomposition.hpp:20</div></div>
<div class="ttc" id="aclasspfc_1_1Decomposition_html_a04df6a82361a68e5ac36808259997f5d"><div class="ttname"><a href="classpfc_1_1Decomposition.html#a04df6a82361a68e5ac36808259997f5d">pfc::Decomposition::outbox</a></div><div class="ttdeci">const heffte::box3d&lt; int &gt; outbox</div><div class="ttdoc">Local communication boxes.</div><div class="ttdef"><b>Definition</b> decomposition.hpp:52</div></div>
<div class="ttc" id="aclasspfc_1_1Decomposition_html_a78a2cd4304a8a69665c3b24503ff8c73"><div class="ttname"><a href="classpfc_1_1Decomposition.html#a78a2cd4304a8a69665c3b24503ff8c73">pfc::Decomposition::inbox</a></div><div class="ttdeci">const heffte::box3d&lt; int &gt; inbox</div><div class="ttdef"><b>Definition</b> decomposition.hpp:52</div></div>
<div class="ttc" id="aclasspfc_1_1FFT_html"><div class="ttname"><a href="classpfc_1_1FFT.html">pfc::FFT</a></div><div class="ttdoc">FFT class for performing forward and backward Fast Fourier Transformations.</div><div class="ttdef"><b>Definition</b> fft.hpp:15</div></div>
<div class="ttc" id="aclasspfc_1_1Model_html"><div class="ttname"><a href="classpfc_1_1Model.html">pfc::Model</a></div><div class="ttdoc">The Model class represents the physics model for simulations in OpenPFC.</div><div class="ttdef"><b>Definition</b> model.hpp:30</div></div>
<div class="ttc" id="aclasspfc_1_1Model_html_a06a03a46398d52a3a3afb7490d3e1c41"><div class="ttname"><a href="classpfc_1_1Model.html#a06a03a46398d52a3a3afb7490d3e1c41">pfc::Model::get_fft</a></div><div class="ttdeci">FFT &amp; get_fft()</div><div class="ttdoc">Get the FFT object associated with the model.</div><div class="ttdef"><b>Definition</b> model.hpp:90</div></div>
<div class="ttc" id="aclasspfc_1_1Model_html_a114dbe9ce04ba6e719e232dea52d4313"><div class="ttname"><a href="classpfc_1_1Model.html#a114dbe9ce04ba6e719e232dea52d4313">pfc::Model::get_decomposition</a></div><div class="ttdeci">const Decomposition &amp; get_decomposition()</div><div class="ttdoc">Get the decomposition object associated with the model.</div><div class="ttdef"><b>Definition</b> model.hpp:66</div></div>
<div class="ttc" id="aclasspfc_1_1Model_html_ac60d580e7e9ce3a268414f92131a95e1"><div class="ttname"><a href="classpfc_1_1Model.html#ac60d580e7e9ce3a268414f92131a95e1">pfc::Model::get_world</a></div><div class="ttdeci">const World &amp; get_world()</div><div class="ttdoc">Get the world object associated with the model.</div><div class="ttdef"><b>Definition</b> model.hpp:73</div></div>
<div class="ttc" id="aclasspfc_1_1Model_html_ade57ace089ccbd4a2a07af3a74aa49d7"><div class="ttname"><a href="classpfc_1_1Model.html#ade57ace089ccbd4a2a07af3a74aa49d7">pfc::Model::rank0</a></div><div class="ttdeci">bool rank0</div><div class="ttdef"><b>Definition</b> model.hpp:39</div></div>
<div class="ttc" id="aclasspfc_1_1World_html"><div class="ttname"><a href="classpfc_1_1World.html">pfc::World</a></div><div class="ttdoc">Represents a world in the simulation domain.</div><div class="ttdef"><b>Definition</b> world.hpp:27</div></div>
<div class="ttc" id="aclasspfc_1_1World_html_a07404e069e3188e737c45964446dec49"><div class="ttname"><a href="classpfc_1_1World.html#a07404e069e3188e737c45964446dec49">pfc::World::dy</a></div><div class="ttdeci">const double dy</div><div class="ttdoc">Discretization parameter in the y-direction.</div><div class="ttdef"><b>Definition</b> world.hpp:38</div></div>
<div class="ttc" id="aclasspfc_1_1World_html_a4a5f1f99377c9ad310c15bfeba8c7fee"><div class="ttname"><a href="classpfc_1_1World.html#a4a5f1f99377c9ad310c15bfeba8c7fee">pfc::World::z0</a></div><div class="ttdeci">const double z0</div><div class="ttdoc">Origin coordinate in the z-direction.</div><div class="ttdef"><b>Definition</b> world.hpp:36</div></div>
<div class="ttc" id="aclasspfc_1_1World_html_a78728443e7c39c89da0a919fcdb584df"><div class="ttname"><a href="classpfc_1_1World.html#a78728443e7c39c89da0a919fcdb584df">pfc::World::dx</a></div><div class="ttdeci">const double dx</div><div class="ttdoc">Discretization parameter in the x-direction.</div><div class="ttdef"><b>Definition</b> world.hpp:37</div></div>
<div class="ttc" id="aclasspfc_1_1World_html_ab0b0ef4d407bcdb3247e3d98884e0434"><div class="ttname"><a href="classpfc_1_1World.html#ab0b0ef4d407bcdb3247e3d98884e0434">pfc::World::Ly</a></div><div class="ttdeci">const int Ly</div><div class="ttdoc">Length in the y-direction.</div><div class="ttdef"><b>Definition</b> world.hpp:32</div></div>
<div class="ttc" id="aclasspfc_1_1World_html_acc6ffdae16ec121877b6b52eb4d20b6e"><div class="ttname"><a href="classpfc_1_1World.html#acc6ffdae16ec121877b6b52eb4d20b6e">pfc::World::x0</a></div><div class="ttdeci">const double x0</div><div class="ttdoc">Origin coordinate in the x-direction.</div><div class="ttdef"><b>Definition</b> world.hpp:34</div></div>
<div class="ttc" id="aclasspfc_1_1World_html_aefac04e64d4287f792ecb22e7f0f3c2f"><div class="ttname"><a href="classpfc_1_1World.html#aefac04e64d4287f792ecb22e7f0f3c2f">pfc::World::dz</a></div><div class="ttdeci">const double dz</div><div class="ttdoc">Discretization parameter in the z-direction.</div><div class="ttdef"><b>Definition</b> world.hpp:39</div></div>
<div class="ttc" id="aclasspfc_1_1World_html_af70d91e76a70f703b84394a8f58df90d"><div class="ttname"><a href="classpfc_1_1World.html#af70d91e76a70f703b84394a8f58df90d">pfc::World::y0</a></div><div class="ttdeci">const double y0</div><div class="ttdoc">Origin coordinate in the y-direction.</div><div class="ttdef"><b>Definition</b> world.hpp:35</div></div>
<div class="ttc" id="aclasspfc_1_1World_html_af70f18f705556771f40034b03fc3a239"><div class="ttname"><a href="classpfc_1_1World.html#af70f18f705556771f40034b03fc3a239">pfc::World::Lz</a></div><div class="ttdeci">const int Lz</div><div class="ttdoc">Length in the z-direction.</div><div class="ttdef"><b>Definition</b> world.hpp:33</div></div>
<div class="ttc" id="aclasspfc_1_1World_html_af816f40f453aaf1b91a339fbc982ed8b"><div class="ttname"><a href="classpfc_1_1World.html#af816f40f453aaf1b91a339fbc982ed8b">pfc::World::Lx</a></div><div class="ttdeci">const int Lx</div><div class="ttdoc">Length in the x-direction.</div><div class="ttdef"><b>Definition</b> world.hpp:31</div></div>
<div class="ttc" id="adecomposition_8hpp_html"><div class="ttname"><a href="decomposition_8hpp.html">decomposition.hpp</a></div></div>
<div class="ttc" id="afft_8hpp_html"><div class="ttname"><a href="fft_8hpp.html">fft.hpp</a></div></div>
<div class="ttc" id="amodel_8hpp_html"><div class="ttname"><a href="model_8hpp.html">model.hpp</a></div></div>
<div class="ttc" id="ampi__timers_8cpp_html_a3a49057ffba576f4b5efe09f8a175879"><div class="ttname"><a href="mpi__timers_8cpp.html#a3a49057ffba576f4b5efe09f8a175879">fft</a></div><div class="ttdeci">void fft()</div><div class="ttdef"><b>Definition</b> mpi_timers.cpp:6</div></div>
<div class="ttc" id="anamespacepfc_html"><div class="ttname"><a href="namespacepfc.html">pfc</a></div><div class="ttdef"><b>Definition</b> array.hpp:18</div></div>
<div class="ttc" id="anamespacepfc_html_aef91c910d177dcf33a7896d436dabdae"><div class="ttname"><a href="namespacepfc.html#aef91c910d177dcf33a7896d436dabdae">pfc::Vec3</a></div><div class="ttdeci">std::array&lt; T, 3 &gt; Vec3</div><div class="ttdef"><b>Definition</b> types.hpp:12</div></div>
<div class="ttc" id="aworld_8hpp_html"><div class="ttname"><a href="world_8hpp.html">world.hpp</a></div></div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.7 </li>
  </ul>
</div>
</body>
</html>
